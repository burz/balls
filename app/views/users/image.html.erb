<div id="user_avatar_display">
  <%= image_tag 'balls-default.jpg', alt: 'Balls', class: 'img-thumbnail' %>
</div>
<% if current_user == @user %>
  <div id="user_avatar_upload_modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="user_image_upload_modal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">
              &times;
            </span>
          </button>
          <h2 class="modal-title">
            Save Avatar
          </h2>
        </div>
        <div class="modal-body">
          <div id="avatar_file_alert" class="alert alert-danger" role="alert">
            No image file chosen.
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="user_avatar">Image</label>
                <input type="file" id="user_avatar" class="form-control">
              </div>
            </div>
            <div class="col-md-6">
              <form id="user_avatar_form">
                <%= image_tag 'balls-default.jpg', alt: 'Balls',
                              id: 'new_avatar', class: 'img-thumbnail' %>
              </form>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button id="save_avatar_button" type="button" class="btn btn-primary">Save</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    $('#avatar_file_alert').hide();
    $('#user_avatar_display').click(function () {
      $('#user_avatar_upload_modal').modal('show');
    });
    function avatar_input (input) {
      if(input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function (event_object) {
          $('#new_avatar').attr('src', event_object.target.result);
        };
        reader.readAsDataURL(input.files[0]);
      }
    }
    $('#user_avatar').change(function () {
      $('#avatar_file_alert').hide();
      avatar_input(this);
    });
    function send_avatar (input) {
      if(input.files && input.files[0]) {
        alert('here');
        var reader = new FileReader();
        reader.onload = function (event_object) {
          var data = { avatar_file: event_object.target.result };
          $.post('<%= user_avatar_path @user %>', data, function () {
            $('#user_avatar_upload_modal').modal('hide');
          });
        };
        reader.readAsBinaryString(input.files[0]);
      } else {
        $('#avatar_file_alert').show();
      }
    }
    $('#save_avatar_button').click(function () {
      $('#avatar_file_alert').hide();
      send_avatar($('#user_avatar')[0]);
    });
  </script>
<% end %>
